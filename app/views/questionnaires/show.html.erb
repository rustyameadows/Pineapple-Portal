<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Questionnaire</p>
            <h1 class="event-section__title"><%= @questionnaire.title %></h1>
            <% if @questionnaire.description.present? %>
              <p class="event-section__lead"><%= simple_format(@questionnaire.description) %></p>
            <% end %>
            <% if @questionnaire.template? %>
              <p><em>This questionnaire is marked as a template.</em></p>
            <% end %>
          </div>
          <div class="event-section__actions">
            <%= link_to "Edit Questionnaire", edit_event_questionnaire_path(@event, @questionnaire), class: "event-section__cta" %>
          </div>
        </header>
      </section>

      <% @sections.each do |section| %>
        <section class="questionnaire-section-view">
          <div class="questionnaire-section-view__content">
            <aside class="questionnaire-section-view__intro">
              <h2><%= section.title %></h2>
              <% if section.helper_text.present? %>
                <p class="questionnaire-section-view__helper"><%= simple_format(section.helper_text) %></p>
              <% end %>
            </aside>

            <% questions = section.questions.order(:position) %>
            <div class="questionnaire-section-view__questions">
              <% if questions.any? %>
                <% questions.each do |question| %>
                  <article class="question-card">
                    <div class="question-card__body">
                      <p class="question-card__prompt"><strong>Prompt:</strong> <%= simple_format(question.prompt) %></p>
                      <% if question.help_text.present? %>
                        <p class="question-card__help"><strong>Help:</strong> <%= simple_format(question.help_text) %></p>
                      <% end %>
                    </div>

                    <% unless @questionnaire.template? %>
                      <div class="question-card__answer">
                        <% if question.answer_value.present? %>
                          <p><strong>Response:</strong> <%= simple_format(question.answer_value) %></p>
                        <% else %>
                          <p class="question-card__answer-empty">No response recorded.</p>
                        <% end %>

                        <% attachments = question.attachments.order(:position) %>
                        <% if attachments.any? %>
                          <h4>Attachments</h4>
                          <ul>
                            <% attachments.each do |attachment| %>
                              <% document = attachment.document || @event.documents.latest.find_by(logical_id: attachment.document_logical_id) %>
                              <% next unless document %>
                              <li>
                                <%= link_to document.title, event_document_path(@event, document) %>
                                (v<%= document.version %>) |
                                <%= link_to "Download", download_event_document_path(@event, document) %>
                              </li>
                            <% end %>
                          </ul>
                        <% end %>
                      </div>
                    <% end %>
                  </article>
                <% end %>
              <% else %>
                <p class="questionnaire-section-view__empty">No questions yet.</p>
              <% end %>
            </div>
          </div>
        </section>
      <% end %>
    </div>
  </div>
<% end %>

<% content_for :scripts do %>
  <%# No interactive scripts needed for read-only view %>
<% end %>
