<h1><%= @questionnaire.title %></h1>

<div class="questionnaire-header">
  <p><strong>Event:</strong> <%= link_to @event.name, event_path(@event) %></p>
  <% if @questionnaire.description.present? %>
    <p><%= simple_format(@questionnaire.description) %></p>
  <% else %>
    <p>No description provided.</p>
  <% end %>
  <% if @questionnaire.template? %>
    <p><em>This questionnaire is marked as a template.</em></p>
  <% end %>
</div>

<p>
  <%= link_to "Add Question", new_questionnaire_question_path(@questionnaire) %> |
  <%= link_to "Edit Questionnaire", edit_questionnaire_path(@questionnaire) %> |
  <%= button_to "Delete Questionnaire", questionnaire_path(@questionnaire), method: :delete, data: { confirm: "Delete this questionnaire?" } %>
</p>

<% if @questions.any? %>
  <% @questions.each do |question| %>
    <section class="question-block">
      <div class="question-content">
        <h3>Question <%= question.position %></h3>
        <p><strong>Prompt:</strong> <%= simple_format(question.prompt) %></p>
        <% if question.help_text.present? %>
          <p><strong>Help:</strong> <%= simple_format(question.help_text) %></p>
        <% end %>
        <p>
          <%= link_to "Edit", edit_question_path(question) %> |
          <%= button_to "Delete", question_path(question), method: :delete, data: { confirm: "Remove this question?" } %>
        </p>
      </div>
      <div class="question-answer">
        <h4>Answer</h4>
        <% if @questionnaire.template? %>
          <p>Templates do not record answers.</p>
        <% elsif question.answer_value.present? %>
          <p><%= simple_format(question.answer_value) %></p>
        <% else %>
          <p>No answer recorded.</p>
        <% end %>

        <% attachments = question.attachments.order(:position) %>
        <% if attachments.any? %>
          <h4>Attachments</h4>
          <ul>
            <% attachments.each do |attachment| %>
              <li>
                <% if attachment.document.present? %>
                  <%= link_to attachment.document.title, event_document_path(@event, attachment.document) %>
                  (v<%= attachment.document.version %>) |
                  <%= link_to "Download", download_event_document_path(@event, attachment.document) %>
                <% elsif attachment.document_logical_id.present? %>
                  <% latest = @event.documents.latest.find_by(logical_id: attachment.document_logical_id) %>
                  <% if latest %>
                    <%= link_to latest.title, event_document_path(@event, latest) %>
                    (latest) |
                    <%= link_to "Download", download_event_document_path(@event, latest) %>
                  <% else %>
                    Latest document (<code><%= attachment.document_logical_id %></code>) not found.
                  <% end %>
                <% end %>
                <% if attachment.notes.present? %>
                  â€“ <%= attachment.notes %>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% end %>

        <% unless @questionnaire.template? %>
          <div class="attachment-form">
            <h4>Add Attachment</h4>
            <%= render "attachments/form", entity: question, documents: documents_for_entity(question) %>
          </div>
        <% end %>
      </div>
    </section>
  <% end %>
<% else %>
  <p>No questions yet.</p>
<% end %>

<% content_for :scripts do %>
  <%= render "attachments/upload_script" %>
<% end %>
