<section class="client-page">
  <header class="client-page__header client-page__header--split">
    <div>
      <h1><%= @payment.title %></h1>
      <p><%= @payment.due_on ? "Due #{@payment.due_on.strftime('%B %-d, %Y')}" : "Timing TBD" %></p>
    </div>
    <div class="client-page__actions">
      <%= link_to "Back to Payments", client_event_financials_path(@event.portal_slug.presence || @event.id), class: "client-button client-button--secondary" %>
    </div>
  </header>

  <section class="client-card client-card--detail">
    <header class="client-card__header">
      <span class="client-pill client-pill--<%= @payment.status %>"><%= @payment.status.humanize %></span>
      <div class="client-card__meta">
        <p><strong>Amount:</strong> <%= number_to_currency(@payment.amount) %></p>
        <p><strong>Due:</strong> <%= @payment.due_on ? @payment.due_on.strftime('%B %-d, %Y') : 'Timing TBD' %></p>
      </div>
    </header>

    <% if @payment.description.present? %>
      <div class="client-card__body">
        <h2>Notes from your planner</h2>
        <%= simple_format(@payment.description) %>
      </div>
    <% end %>

    <% if @payment.paid? %>
      <div class="client-card__body client-card__body--muted">
        <h2>Payment received</h2>
        <p>Marked paid <%= l(@payment.paid_at, format: :long) %>.</p>
        <% if @payment.client_note.present? %>
          <p class="client-card__hint"><strong>Your note</strong></p>
          <p><%= simple_format(@payment.client_note) %></p>
        <% end %>
      </div>
    <% else %>
      <div class="client-card__body">
        <h2>Let your planner know it’s paid</h2>
        <p>Once you’ve sent payment, leave a short note so your planner can reconcile it quickly.</p>
        <%= form_with url: mark_paid_client_event_payment_path(@event.portal_slug.presence || @event.id, @payment), method: :patch, class: "client-form" do |form| %>
          <div class="client-form__group">
            <%= form.label :client_note, "Add a note (optional)" %>
            <%= form.text_area :client_note, rows: 3, placeholder: "Include a check number, transfer confirmation, or anything helpful." %>
          </div>
          <div class="client-form__actions">
            <%= form.submit "Mark as Paid", class: "client-button" %>
          </div>
        <% end %>
      </div>
    <% end %>
  </section>

  <section class="client-card client-card--attachments">
    <header class="client-card__header">
      <h2>Attachments</h2>
    </header>
    <% if @attachments.any? %>
      <ul class="client-attachment-list">
        <% @attachments.each do |attachment| %>
          <% document = attachment.resolved_document %>
          <li>
            <% if document.present? %>
              <%= link_to document.title, download_event_document_path(@event, document) %>
              <span class="client-attachment-meta">(v<%= document.version %>)</span>
            <% elsif attachment.document_logical_id.present? %>
              Logical ID: <%= attachment.document_logical_id %>
            <% else %>
              <span>No document linked.</span>
            <% end %>
            <% if attachment.notes.present? %>
              <p class="client-attachment-notes"><%= attachment.notes %></p>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="client-empty">No supporting documents yet.</p>
    <% end %>
  </section>
</section>
