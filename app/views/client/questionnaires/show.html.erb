<section class="client-page">
  <% status_label = @questionnaire.finished? ? "Finished" : "In Progress" %>

  <header class="client-page__header client-questionnaire__header">
    <div>
      <h1><%= @questionnaire.title %></h1>
      <p class="client-questionnaire__status">
        <span class="client-status-tag <%= @questionnaire.finished? ? 'client-status-tag--finished' : 'client-status-tag--in-progress' %>">
          <%= status_label %>
        </span>
      </p>
      <% if @questionnaire.description.present? %>
        <p><%= simple_format(@questionnaire.description) %></p>
      <% end %>
    </div>
    <div class="client-questionnaire__header-actions">
      <% if @questionnaire.finished? %>
        <%= button_to "Mark as In Progress", mark_in_progress_client_event_questionnaire_path(@event, @questionnaire), method: :patch, class: "client-questionnaire__status-action" %>
      <% else %>
        <%= button_to "Mark as Finished", mark_finished_client_event_questionnaire_path(@event, @questionnaire), method: :patch, class: "client-questionnaire__status-action" %>
      <% end %>
    </div>
  </header>

  <% @sections.each do |section| %>
    <% questions = section.questions.order(:position) %>
    <section class="client-questionnaire__section">
      <div class="client-questionnaire__layout">
        <aside class="client-questionnaire__intro">
          <h2><%= section.title %></h2>
          <% if section.helper_text.present? %>
            <p class="client-questionnaire__helper"><%= simple_format(section.helper_text) %></p>
          <% end %>
        </aside>

        <div class="client-questionnaire__questions">
          <% if questions.any? %>
            <% questions.each do |question| %>
              <article class="client-questionnaire__question">
                <p class="client-questionnaire__prompt"><strong><%= question.prompt %></strong></p>
                <% if question.help_text.present? %>
                  <p class="client-questionnaire__helper"><%= simple_format(question.help_text) %></p>
                <% end %>

                <%= form_with url: client_event_questionnaire_question_answer_path(@event, @questionnaire, question), method: :patch, scope: :question, local: true do |form| %>
                  <div class="client-questionnaire__control">
                    <% case question.response_type %>
                    <% when "boolean" %>
                      <%= form.label :answer_value, "Your response" %><br>
                      <%= form.select :answer_value, options_for_select([["Select", ""], ["Yes", "Yes"], ["No", "No"]], question.answer_value), include_blank: false %>
                    <% else %>
                      <%= form.label :answer_value, "Your response" %><br>
                      <%= form.text_area :answer_value, value: question.answer_value, rows: 4 %>
                    <% end %>
                  </div>

                  <div class="client-questionnaire__actions">
                    <%= form.submit "Save response" %>
                  </div>
                <% end %>
              </article>
            <% end %>
          <% else %>
            <p class="client-questionnaire__empty">No questions in this section yet.</p>
          <% end %>
        </div>
      </div>
    </section>
  <% end %>
</section>
