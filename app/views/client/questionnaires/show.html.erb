<section class="client-page client-questionnaire" data-controller="questionnaire">
  <% status_label = @questionnaire.finished? ? "Finished" : "In Progress" %>

  <header class="client-page__header client-questionnaire__header">
    <div>
      <h1><%= @questionnaire.title %></h1>
      <p class="client-questionnaire__status">
        <span class="client-status-tag <%= @questionnaire.finished? ? 'client-status-tag--finished' : 'client-status-tag--in-progress' %>">
          <%= status_label %>
        </span>
      </p>
      <% if @questionnaire.description.present? %>
        <p><%= simple_format(@questionnaire.description) %></p>
      <% end %>
    </div>
  </header>

  <% @sections.each do |section| %>
    <% questions = section.questions.order(:position) %>
    <section class="client-questionnaire__section">
      <div class="client-container client-questionnaire__section-inner">
        <div class="client-questionnaire__layout">
          <aside class="client-questionnaire__intro">
            <div class="client-questionnaire__intro-inner">
              <h2><%= section.title %></h2>
              <% if section.helper_text.present? %>
                <p><%= simple_format(section.helper_text) %></p>
              <% end %>
            </div>
          </aside>

          <div class="client-questionnaire__questions">
            <% if questions.any? %>
              <% questions.each do |question| %>
                <% tooltip_id = "question-tooltip-#{question.id}" %>
                <% attachments = question.attachments.answer.includes(:document).order(:position) %>
                <article class="client-questionnaire__question"
                         data-controller="question-attachment"
                         data-question-attachment-presign-url-value="<%= presign_event_documents_path(@event) %>"
                         data-question-attachment-attachments-path-value="<%= attachments_path(format: :json) %>"
                         data-question-attachment-entity-type-value="Question"
                         data-question-attachment-entity-id-value="<%= question.id %>">
                  <div class="client-questionnaire__prompt">
                    <strong><%= question.prompt %></strong>
                    <% if question.help_text.present? %>
                      <span class="client-questionnaire__tooltip">
                        <button type="button" class="client-questionnaire__tooltip-trigger" aria-describedby="<%= tooltip_id %>">
                          <span aria-hidden="true">?</span>
                          <span class="client-questionnaire__tooltip-text">More info</span>
                        </button>
                        <div id="<%= tooltip_id %>" role="tooltip" class="client-questionnaire__tooltip-content">
                          <%= simple_format(question.help_text) %>
                        </div>
                      </span>
                    <% end %>
                  </div>

                  <%= form_with url: client_event_questionnaire_question_answer_path(@event, @questionnaire, question),
                                method: :patch,
                                scope: :question,
                                local: true,
                                data: { questionnaire_target: "form" } do |form| %>
                    <div class="client-questionnaire__control">
                      <%= form.label :answer_value, "Your response", class: "visually-hidden" %>
                      <div class="client-questionnaire__answer-shell"
                           data-question-attachment-target="shell"
                           data-action="dragover->question-attachment#dragOver dragleave->question-attachment#dragLeave drop->question-attachment#drop">
                        <% case question.response_type %>
                        <% when "boolean" %>
                          <%= form.select :answer_value, options_for_select([["Select", ""], ["Yes", "Yes"], ["No", "No"]], question.answer_value), include_blank: false %>
                        <% else %>
                          <%= form.text_area :answer_value, value: question.answer_value, rows: 4 %>
                        <% end %>

                        <div class="client-questionnaire__attachment-zone">
                          <ul class="client-questionnaire__attachments"
                              data-question-attachment-target="attachmentList">
                            <%= render partial: "client/questionnaires/attachment_chip",
                                       collection: attachments,
                                       as: :attachment,
                                       locals: { event: @event } %>
                          </ul>
                          <button type="button"
                                  class="client-questionnaire__dropzone"
                                  data-question-attachment-target="dropzone"
                                  data-action="dragover->question-attachment#dragOver dragleave->question-attachment#dragLeave drop->question-attachment#drop click->question-attachment#openFileDialog">
                            <span aria-hidden="true">ï¼‹</span>
                            <span class="client-questionnaire__dropzone-text">Add file</span>
                          </button>
                          <input type="file"
                                 class="client-questionnaire__file-input"
                                 data-question-attachment-target="fileInput"
                                 data-action="change->question-attachment#handleFileSelection">
                          <p class="client-questionnaire__attachment-status"
                                 data-question-attachment-target="status"></p>
                          <p class="client-questionnaire__attachment-empty"
                                 data-question-attachment-target="emptyState"
                             <%= "hidden" if attachments.any? %>>No files attached yet.</p>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </article>
              <% end %>
            <% else %>
              <p class="client-questionnaire__empty">No questions in this section yet.</p>
            <% end %>
          </div>
        </div>
      </div>
    </section>
  <% end %>

  <footer class="client-questionnaire__footer">
    <div class="client-container">
      <div class="client-questionnaire__footer-actions">
        <% if @questionnaire.finished? %>
          <%= button_to "Mark as In Progress", mark_in_progress_client_event_questionnaire_path(@event, @questionnaire), method: :patch, class: "client-questionnaire__status-action client-questionnaire__status-action--secondary" %>
        <% else %>
          <%= button_to "Mark as Finished", mark_finished_client_event_questionnaire_path(@event, @questionnaire), method: :patch, class: "client-questionnaire__status-action" %>
        <% end %>
        <button type="button" class="client-questionnaire__save-action" data-action="questionnaire#saveAll" data-questionnaire-target="saveButton">
          Save all responses
        </button>
      </div>
    </div>
  </footer>
</section>

<%= render "client/shared/footer" %>
