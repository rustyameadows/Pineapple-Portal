<% user = local_assigns.fetch(:user) %>
<% first_account = local_assigns.fetch(:first_account, false) %>
<% allow_role_select = local_assigns.fetch(:allow_role_select, false) %>
<% submit_label = local_assigns.fetch(:submit_label, user.new_record? ? (first_account ? "Create Account" : "Invite Teammate") : "Save Changes") %>
<% require_password = local_assigns.fetch(:require_password, user.new_record?) %>
<% role_options = Array(local_assigns[:role_options]).presence || User.roles.keys %>
<% role_option_pairs = role_options.map { |role| [role.to_s.humanize, role.to_s] } %>

<%= form_with model: user, local: true, class: "stack" do |form| %>
  <div>
    <%= form.label :name %>
    <%= form.text_field :name, required: true %>
  </div>

  <div>
    <%= form.label :title, "Title" %>
    <%= form.text_field :title, placeholder: "Lead Planner" %>
  </div>

  <div>
    <%= form.label :phone_number, "Phone" %>
    <%= form.telephone_field :phone_number, placeholder: "555-123-4567" %>
  </div>

  <div>
    <%= form.label :email %>
    <%= form.email_field :email, required: true %>
  </div>

  <% if allow_role_select %>
    <div>
      <%= form.label :role %>
      <%= form.select :role, role_option_pairs, {}, {} %>
    </div>
  <% elsif user.role.present? %>
    <%= form.hidden_field :role, value: user.role %>
  <% end %>

  <div>
    <%= form.label :password %>
    <% password_options = { autocomplete: user.new_record? ? "new-password" : "off" } %>
    <% password_options[:required] = true if require_password %>
    <%= form.password_field :password, **password_options %>
    <% unless require_password %>
      <p class="form-help">Leave blank to keep the current password.</p>
    <% end %>
  </div>

  <div>
    <%= form.label :password_confirmation %>
    <% confirmation_options = { autocomplete: user.new_record? ? "new-password" : "off" } %>
    <% confirmation_options[:required] = true if require_password %>
    <%= form.password_field :password_confirmation, **confirmation_options %>
  </div>

  <% return_to_value = local_assigns[:return_to].presence || (defined?(@return_to) && @return_to.present? ? @return_to : nil) %>
  <% if return_to_value.present? %>
    <%= hidden_field_tag :return_to, return_to_value %>
  <% end %>

<%= form.submit submit_label %>
<% end %>

<% if user.persisted? %>
  <section class="user-avatar-section">
    <div class="user-avatar-section__preview">
      <h3 class="user-avatar-section__heading">Current Photo</h3>
      <% if user.avatar_global_asset.present? %>
        <% avatar_uri = inline_global_asset_data_uri(user.avatar_global_asset) %>
        <% if avatar_uri.present? %>
          <img src="<%= avatar_uri %>" alt="<%= user.name %> avatar" class="user-avatar-section__image">
        <% else %>
          <div class="user-avatar-section__placeholder">Image unavailable. Re-upload below.</div>
        <% end %>
      <% else %>
        <div class="user-avatar-section__placeholder">No photo yet.</div>
      <% end %>
    </div>

    <div class="user-avatar-section__upload">
      <h3 class="user-avatar-section__heading">Upload New Photo</h3>
      <%= form_with scope: :document,
                    url: user_avatar_assets_path(user),
                    method: :post,
                    local: true,
                    data: { document_upload_form: true, presign_url: global_assets_presign_path },
                    html: { class: "user-avatar-upload" } do |upload_form| %>
        <div class="user-avatar-upload__picker">
          <label class="user-avatar-upload__label" for="document_file">Choose image</label>
          <input type="file" id="document_file" accept="image/*" data-document-upload-target="file">
        </div>

        <div class="document-upload" data-document-upload-target="ui">
          <div class="document-upload__progress" data-document-upload-target="progress" hidden>
            <div class="document-upload__progress-track" aria-hidden="true">
              <div class="document-upload__progress-bar" data-document-upload-target="progressBar"></div>
            </div>
            <div class="document-upload__progress-status">
              <span data-document-upload-target="progressLabel">Uploadingâ€¦</span>
              <span class="document-upload__progress-percent" data-document-upload-target="progressPercent">0%</span>
            </div>
          </div>

          <p class="document-upload__status" data-document-upload-target="status">Select a file to upload to R2.</p>
        </div>

        <%= upload_form.hidden_field :title %>
        <%= upload_form.hidden_field :storage_uri %>
        <%= upload_form.hidden_field :checksum %>
        <%= upload_form.hidden_field :size_bytes %>
        <%= upload_form.hidden_field :content_type %>
        <%= upload_form.hidden_field :logical_id %>

        <div class="user-avatar-upload__actions">
          <%= upload_form.submit "Upload image", class: "button button--small", disabled: true %>
        </div>
      <% end %>
      <p class="user-avatar-upload__hint">Uploading a new image will replace the current photo.</p>
    </div>
  </section>

  <%= render "documents/upload_script" %>
<% end %>
