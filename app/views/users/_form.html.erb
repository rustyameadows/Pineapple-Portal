<% user = local_assigns.fetch(:user) %>
<% first_account = local_assigns.fetch(:first_account, false) %>
<% allow_role_select = local_assigns.fetch(:allow_role_select, false) %>
<% submit_label = local_assigns.fetch(:submit_label, user.new_record? ? (first_account ? "Create Account" : "Invite Teammate") : "Save Changes") %>
<% require_password = local_assigns.fetch(:require_password, user.new_record?) %>
<% role_options = Array(local_assigns[:role_options]).presence || User.roles.keys %>
<% role_option_pairs = role_options.map { |role| [role.to_s.humanize, role.to_s] } %>
<% account_kind_options = User.account_kinds.keys.map { |kind| [kind.humanize, kind] } %>

<%= form_with model: user, local: true, class: "event-form event-form--stack" do |form| %>
  <div class="event-form__section">
    <div class="event-form__grid">
      <div class="event-form__group">
        <%= form.label :account_kind, "Account Type" %>
        <%= form.select :account_kind, account_kind_options, {}, { data: { account_kind_select: true, account_kind_control: true } } %>
        <p class="event-form__hint">Choose “Contact” for planners who won't need their own login.</p>
      </div>

      <% if allow_role_select %>
        <div class="event-form__group">
          <%= form.label :role %>
          <%= form.select :role, role_option_pairs, {}, {} %>
        </div>
      <% elsif user.role.present? %>
        <%= form.hidden_field :role, value: user.role %>
      <% end %>
    </div>
  </div>

  <div class="event-form__section">
    <div class="event-form__grid">
      <div class="event-form__group">
        <%= form.label :name %>
        <%= form.text_field :name, required: true %>
      </div>

      <div class="event-form__group">
        <%= form.label :title, "Title" %>
        <%= form.text_field :title, placeholder: "Lead Planner" %>
      </div>

      <div class="event-form__group">
        <%= form.label :phone_number, "Phone" %>
        <%= form.telephone_field :phone_number, placeholder: "555-123-4567" %>
      </div>

      <div class="event-form__group" data-email-field>
        <%= form.label :email %>
        <%= form.email_field :email, required: !user.contact?, data: { email_input: true } %>
        <p class="event-form__hint">Required for portal accounts.</p>
      </div>
    </div>
  </div>

  <div class="event-form__section">
    <div class="event-form__grid">
      <div class="event-form__group">
        <%= form.label :general_notes, "General notes" %>
        <%= form.text_area :general_notes, rows: 3, placeholder: "Notes visible to planners and clients" %>
      </div>
      <div class="event-form__group">
        <%= form.label :dietary_restrictions, "Dietary restrictions" %>
        <%= form.text_area :dietary_restrictions, rows: 3, placeholder: "Allergies or dietary needs" %>
      </div>
    </div>
  </div>

  <div class="event-form__section" data-password-section data-require-password="<%= require_password %>">
    <div class="event-form__grid">
      <div class="event-form__group" data-password-fields>
        <%= form.label :password %>
        <% password_options = { autocomplete: user.new_record? ? "new-password" : "off" } %>
        <% password_options[:required] = true if require_password %>
        <%= form.password_field :password, **password_options %>
        <% unless require_password %>
          <p class="event-form__hint">Leave blank to keep the current password.</p>
        <% end %>
      </div>

      <div class="event-form__group" data-password-fields>
        <%= form.label :password_confirmation %>
        <% confirmation_options = { autocomplete: user.new_record? ? "new-password" : "off" } %>
        <% confirmation_options[:required] = true if require_password %>
        <%= form.password_field :password_confirmation, **confirmation_options %>
      </div>
    </div>
  </div>

  <% return_to_value = local_assigns[:return_to].presence || (defined?(@return_to) && @return_to.present? ? @return_to : nil) %>
  <% if return_to_value.present? %>
    <%= hidden_field_tag :return_to, return_to_value %>
  <% end %>

  <div class="event-form__actions">
    <%= form.submit submit_label, class: "event-form__submit" %>
    <%= link_to "Cancel", (return_to_value.presence || users_path), class: "event-form__cancel" %>
  </div>
<% end %>

<% if user.persisted? %>
  <section class="user-avatar-section">
    <div class="user-avatar-section__preview">
      <h3 class="user-avatar-section__heading">Current Photo</h3>
      <% if user.avatar_global_asset.present? %>
        <% avatar_uri = inline_global_asset_data_uri(user.avatar_global_asset) %>
        <% if avatar_uri.present? %>
          <img src="<%= avatar_uri %>" alt="<%= user.name %> avatar" class="user-avatar-section__image">
        <% else %>
          <div class="user-avatar-section__placeholder">Image unavailable. Re-upload below.</div>
        <% end %>
      <% else %>
        <div class="user-avatar-section__placeholder">No photo yet.</div>
      <% end %>
    </div>

    <div class="user-avatar-section__upload">
      <h3 class="user-avatar-section__heading">Upload New Photo</h3>
      <%= form_with scope: :document,
                    url: user_avatar_assets_path(user),
                    method: :post,
                    local: true,
                    data: { document_upload_form: true, presign_url: global_assets_presign_path },
                    html: { class: "user-avatar-upload" } do |upload_form| %>
        <div class="user-avatar-upload__picker">
          <label class="user-avatar-upload__label" for="document_file">Choose image</label>
          <input type="file" id="document_file" accept="image/*" data-document-upload-target="file">
        </div>

        <div class="document-upload" data-document-upload-target="ui">
          <div class="document-upload__progress" data-document-upload-target="progress" hidden>
            <div class="document-upload__progress-track" aria-hidden="true">
              <div class="document-upload__progress-bar" data-document-upload-target="progressBar"></div>
            </div>
            <div class="document-upload__progress-status">
              <span data-document-upload-target="progressLabel">Uploading…</span>
              <span class="document-upload__progress-percent" data-document-upload-target="progressPercent">0%</span>
            </div>
          </div>

          <p class="document-upload__status" data-document-upload-target="status">Select a file to upload to R2.</p>
        </div>

        <%= upload_form.hidden_field :title %>
        <%= upload_form.hidden_field :storage_uri %>
        <%= upload_form.hidden_field :checksum %>
        <%= upload_form.hidden_field :size_bytes %>
        <%= upload_form.hidden_field :content_type %>
        <%= upload_form.hidden_field :logical_id %>

        <div class="user-avatar-upload__actions">
          <%= upload_form.submit "Upload image", class: "button button--small", disabled: true %>
        </div>
      <% end %>
      <p class="user-avatar-upload__hint">Uploading a new image will replace the current photo.</p>
    </div>
  </section>

  <%= render "documents/upload_script" %>
<% end %>

<script>
  (function() {
    var requirePassword = false;

    function toggleFields(selectEl) {
      var passwordContainer = document.querySelectorAll("[data-password-fields]");
      var emailInput = document.querySelector("[data-email-input]");
      if (!selectEl) return;

      var isContact = selectEl.value === "contact";

      passwordContainer.forEach(function(container) {
        if (!container) return;
        container.style.display = isContact ? "none" : "";
        container.querySelectorAll("input[type='password']").forEach(function(input) {
          if (isContact) {
            input.removeAttribute("required");
            input.value = "";
          } else if (requirePassword) {
            input.required = true;
          } else {
            input.removeAttribute("required");
          }
        });
      });

      if (emailInput) {
        if (isContact) {
          emailInput.removeAttribute("required");
        } else {
          emailInput.required = true;
        }
      }
    }

    function ready(fn) {
      if (document.readyState !== "loading") {
        fn();
      } else {
        document.addEventListener("DOMContentLoaded", fn);
      }
      document.addEventListener("turbo:load", fn);
    }

    ready(function() {
      var selectEl = document.querySelector("[data-account-kind-select]");
      var passwordSection = document.querySelector("[data-password-section]");
      requirePassword = passwordSection && passwordSection.dataset.requirePassword === "true";

      function setPasswordRequired(enable) {
        var passwordInputs = document.querySelectorAll("[data-password-fields] input[type='password']");
        passwordInputs.forEach(function(input) {
          if (enable) {
            input.required = true;
          } else {
            input.removeAttribute("required");
          }
        });
      }

      toggleFields(selectEl);
      if (selectEl) {
        selectEl.addEventListener("change", function(event) {
          toggleFields(event.target);
        });
      }

      if (requirePassword) {
        setPasswordRequired(true);
      }
    });
  })();
</script>
