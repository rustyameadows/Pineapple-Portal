<%
  event_for_entity = case entity
                     when Event then entity
                     when Questionnaire then entity.event
                     when Question then entity.event
                     when Payment then entity.event
                     when Approval then entity.event
                     else
                       nil
                     end
  presign_url = event_for_entity ? presign_event_documents_path(event_for_entity) : nil
  question_entity = entity.is_a?(Question)
  next_position = entity.attachments.maximum(:position).to_i + 1
%>

<%= form_with url: attachments_path, data: (presign_url ? { attachment_upload_form: true, presign_url: presign_url } : {}) do |form| %>
  <%= form.hidden_field :entity_type, value: entity.class.name %>
  <%= form.hidden_field :entity_id, value: entity.id %>

  <% if documents.any? %>
    <fieldset>
      <legend>Link existing document</legend>
      <div>
        <%= form.label :document_id, "Document version" %><br>
        <%= form.collection_select :document_id, documents, :id, ->(doc) { "#{doc.title} (v#{doc.version})" }, include_blank: true %>
      </div>

      <div>
        <%= form.label :document_logical_id, "Logical ID (optional)" %><br>
        <%= form.text_field :document_logical_id %>
        <p>Provide this to always reference the latest version. Leave blank if selecting a specific version above.</p>
      </div>
    </fieldset>
  <% end %>

  <% if presign_url %>
    <fieldset>
      <legend>or upload a file</legend>
      <div>
        <label for="attachment_file_<%= entity.id %>">File</label><br>
        <input type="file" id="attachment_file_<%= entity.id %>" data-attachment-upload-target="file">
      </div>

      <div class="attachment-upload" data-attachment-upload-target="ui">
        <div class="attachment-upload__progress" data-attachment-upload-target="progress" hidden>
          <div class="attachment-upload__progress-track" aria-hidden="true">
            <div class="attachment-upload__progress-bar" data-attachment-upload-target="progressBar"></div>
          </div>
          <div class="attachment-upload__progress-status">
            <span data-attachment-upload-target="progressLabel">Uploadingâ€¦</span>
            <span class="attachment-upload__progress-percent" data-attachment-upload-target="progressPercent">0%</span>
          </div>
        </div>

        <p class="attachment-upload__status" data-attachment-upload-target="status">Optional: upload a new file to attach.</p>
      </div>

      <%= form.hidden_field :file_upload_title %>
      <%= form.hidden_field :file_upload_storage_uri %>
      <%= form.hidden_field :file_upload_checksum %>
      <%= form.hidden_field :file_upload_size_bytes %>
      <%= form.hidden_field :file_upload_content_type %>
      <%= form.hidden_field :file_upload_logical_id %>
    </fieldset>
  <% end %>

  <% if question_entity %>
    <%= form.hidden_field :context, value: "answer" %>
    <%= form.hidden_field :position, value: next_position %>
  <% else %>
    <div>
      <%= form.label :context %><br>
      <%= form.select :context, Attachment.contexts.keys.map { |key| [key.humanize, key] } %>
    </div>

    <div>
      <%= form.label :position %><br>
      <%= form.number_field :position, value: next_position, min: 1 %>
    </div>
  <% end %>

  <div>
    <%= form.label :notes %><br>
    <%= form.text_field :notes %>
  </div>

  <div>
    <%= form.submit "Add Attachment" %>
  </div>
<% end %>
