<% sections = event_sidebar_sections(event) %>
<% current_path = request.path %>

<aside class="event-sidebar">
  <div class="event-sidebar__header">
    <div class="event-sidebar__brand">
      <%= link_to root_path, class: "event-sidebar__brand-link", title: "Pineapple Productions" do %>
        <span class="event-sidebar__brand-top" aria-hidden="true">Pineapple</span>
        <span class="event-sidebar__brand-bottom" aria-hidden="true">Productions</span>
        <span class="sr-only">Pineapple Productions</span>
      <% end %>
    </div>
  </div>

  <div class="event-sidebar__context">
    <span class="event-sidebar__context-label">Currently Viewing</span>
    <h2 class="event-sidebar__event-name">
      <%= link_to event.name, event_path(event), class: "event-sidebar__event-link", title: event.name %>
    </h2>
  </div>

  <nav class="event-sidebar__nav" aria-label="Event navigation">
    <ul class="event-sidebar__sections">
      <% sections.each do |section| %>
        <% active = event_sidebar_section_active?(section, current_path) %>
        <% top_path = section[:path] %>
        <% stub = top_path.blank? %>
        <% link_classes = ["event-sidebar__link"] %>
        <% link_classes << "event-sidebar__link--stub" if stub %>
        <% link_classes << "event-sidebar__link--active" if active %>
        <li class="event-sidebar__section<%= ' event-sidebar__section--active' if active %>">
          <%= link_to(top_path.presence || '#',
                      class: link_classes.join(' '),
                      title: section[:label],
                      aria: { label: section[:label], current: (active && !stub ? 'page' : nil) }.compact,
                      data: (stub ? { turbo: false } : {})) do %>
            <span class="event-sidebar__link-label" aria-hidden="true"><%= section[:label] %></span>
          <% end %>

          <% if active && section[:sub_links].present? %>
            <ul class="event-sidebar__subnav">
              <% section[:sub_links].each do |sub_link| %>
                <% sub_path = sub_link[:path] %>
                <% sub_stub = sub_path.blank? %>
                <% sub_active = !sub_stub && current_path.start_with?(sub_path) %>
                <% sub_classes = ["event-sidebar__subnav-link"] %>
                <% sub_classes << "event-sidebar__subnav-link--stub" if sub_stub %>
                <% sub_classes << "event-sidebar__subnav-link--active" if sub_active %>
                <li>
                  <%= link_to(sub_path.presence || '#',
                              class: sub_classes.join(' '),
                              title: sub_link[:label],
                              aria: { label: sub_link[:label], current: (sub_active && !sub_stub ? 'page' : nil) }.compact,
                              data: (sub_stub ? { turbo: false } : {})) do %>
                    <span class="event-sidebar__link-label" aria-hidden="true"><%= sub_link[:label] %></span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          <% end %>
        </li>
      <% end %>
    </ul>
  </nav>

  <footer class="event-sidebar__footer" aria-label="Account navigation">
    <%= link_to "Home", events_path, class: "event-sidebar__footer-button" %>

    <% if logged_in? %>
      <%= button_to "Log Out", logout_path,
                    method: :delete,
                    class: "event-sidebar__footer-button",
                    data: { turbo_method: :delete },
                    form: { data: { turbo: true } } %>
    <% else %>
      <%= link_to "Log In", login_path, class: "event-sidebar__footer-button" %>
    <% end %>
  </footer>
</aside>
