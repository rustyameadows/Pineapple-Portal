<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

	      <section class="event-section">
	        <header class="event-section__header">
	          <div>
	            <p class="event-section__eyebrow">Calendars</p>
            <h1 class="event-section__title">Timeline Views</h1>
            <p class="event-section__subtitle">Choose a calendar to review schedules or share filtered views.</p>
          </div>
          <div class="event-section__actions">
            <%= button_to "Add default timelines",
                          add_defaults_event_calendar_views_path(@event),
                          method: :post,
                          class: "event-section__cta event-section__cta--secondary" %>
            <%= link_to "New Derived Calendar", new_event_calendar_view_path(@event), class: "event-section__cta" %>
          </div>
        </header>

        <div class="calendar-list">
          <article class="calendar-card">
            <header class="calendar-card__header">
              <h2 class="calendar-card__title"><%= @calendar.name %></h2>
              <span class="calendar-card__badge">Run of Show</span>
            </header>
            <p class="calendar-card__description"><%= @calendar.description.presence || "Master schedule shared with your team." %></p>
            <dl class="calendar-card__meta">
              <div>
                <dt>Items</dt>
                <dd><%= @calendar.calendar_items.count %></dd>
              </div>
              <div>
                <dt>Timezone</dt>
                <dd><%= ActiveSupport::TimeZone[@calendar.timezone]&.to_s || @calendar.timezone %></dd>
              </div>
              <div>
                <dt>Client Portal</dt>
                <dd><%= @calendar.client_visible? ? "Visible" : "Hidden" %></dd>
              </div>
            </dl>
            <div class="calendar-card__actions">
              <%= link_to "View Schedule", event_calendar_path(@event), class: "event-section__link" %>
            </div>
            <div class="calendar-card__meta">
              <div>
                <dt>Timezone</dt>
                <dd>
                  <%= form_with model: @calendar,
                                url: event_calendar_path(@event),
                                method: :patch,
                                class: "event-form",
                                data: { turbo: true } do |form| %>
                    <%= form.select :timezone,
                                    @time_zones.map { |tz| [tz.to_s, tz.tzinfo&.identifier || tz.name] },
                                    {},
                                    class: "event-form__select",
                                    style: "max-width: 14rem;" %>
                    <div style="margin-top: 0.35rem;">
                      <%= form.submit "Save Timezone", class: "event-form__submit event-form__submit--small" %>
                    </div>
                  <% end %>
                </dd>
              </div>
            </div>
          </article>

          <% if @views.any? %>
            <table class="event-table calendar-card__table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Tags</th>
                  <th>Client Portal</th>
                  <th>Items</th>
                </tr>
              </thead>
              <tbody>
                <% @views.each do |view| %>
                  <tr>
                    <td><%= link_to view.name, event_calendar_view_path(@event, view), class: "event-calendars__title-link" %></td>
                    <td><%= view.description.presence || "Derived view from the run of show." %></td>
                    <td>
                      <% if view.tag_filter.present? %>
                        <%= view.tag_filter.map { |id| @tag_lookup[id]&.name }.compact.join(', ') %>
                      <% else %>
                        <span class="event-table__status">All items</span>
                      <% end %>
                    </td>
                    <td><%= view.client_visible? ? "Visible" : "Hidden" %></td>
                    <td><%= Calendars::ViewFilter.new(calendar: @calendar, view: view).items.count %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <div class="event-section__empty">
              <p>No derived calendars yet. Create one to tailor the schedule for different audiences.</p>
            </div>
	          <% end %>
	        </div>
	      </section>

	      <section class="event-section event-calendars__tags">
	        <header class="event-section__header event-calendars__tags-header">
	          <div>
	            <p class="event-section__eyebrow">Tags</p>
	            <h2 class="event-section__title">Organize by Tag</h2>
	            <p class="event-section__subtitle">Color-coded tags help surface the right items in derived calendars.</p>
	          </div>
		          <div class="event-section__actions">
		            <%= button_to "Add default tags",
		                          add_defaults_event_calendar_tags_path(@event),
		                          method: :post,
		                          class: "event-section__cta event-section__cta--secondary" %>
		            <%= button_to "Restore default colors",
		                          restore_default_colors_event_calendar_tags_path(@event),
		                          method: :post,
		                          class: "event-section__cta event-section__cta--secondary" %>
		          </div>
		        </header>

	        <% if @tags.any? %>
	          <ul class="event-calendars__tag-list">
	            <% @tags.each do |tag| %>
	              <li class="event-calendars__tag-row">
	                <div class="event-calendars__tag-info">
	                  <strong class="event-calendars__tag-name"><%= tag.name %></strong>
	                  <span class="event-tag-pill" style="<%= calendar_tag_style(tag) %>"><%= tag.name %></span>
	                  <span class="event-calendars__tag-count"><%= tag.calendar_items.count %> items</span>
	                </div>
	                <%= form_with model: tag, url: event_calendar_tag_path(@event, tag), class: "event-calendars__tag-form", method: :patch do |form| %>
	                  <div class="event-calendars__tag-fields">
	                    <%= form.text_field :name, placeholder: "Name", class: "event-calendars__input" %>
	                    <%= form.text_field :color_token, placeholder: "Color", class: "event-calendars__input event-calendars__input--color" %>
	                    <div class="event-calendars__tag-actions">
	                      <%= form.submit "Save", class: "event-form__submit event-form__submit--small" %>
	                      <%= link_to "Remove", event_calendar_tag_path(@event, tag), data: { turbo_confirm: "Remove this tag?", turbo_method: :delete }, class: "event-form__cancel" %>
	                    </div>
	                  </div>
	                <% end %>
	              </li>
	            <% end %>
	          </ul>
	        <% else %>
	          <div class="event-section__empty">
	            <p>No tags yet. Add one below to start grouping schedule items.</p>
	          </div>
	        <% end %>

	        <%= form_with model: @new_tag, url: event_calendar_tags_path(@event), class: "event-form event-calendars__new-tag" do |form| %>
	          <div class="event-calendars__tag-fields">
	            <%= form.text_field :name, placeholder: "New tag", class: "event-calendars__input", required: true %>
	            <%= form.text_field :color_token, placeholder: "Color (optional)", class: "event-calendars__input event-calendars__input--color" %>
	            <div class="event-form__actions event-calendars__tag-actions">
	              <%= form.submit "Add Tag", class: "event-form__submit event-form__submit--small" %>
	            </div>
	          </div>
	        <% end %>
	      </section>
	    </div>
	  </div>
	<% end %>
