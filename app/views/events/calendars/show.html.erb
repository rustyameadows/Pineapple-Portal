<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <div class="event-breadcrumb">
        <%= link_to "← Back to Calendars", event_calendars_path(@event), class: "event-section__link" %>
      </div>

      <section class="event-section event-calendars__details">
        <header class="event-section__header event-calendars__header">
          <div>
            <p class="event-section__eyebrow">Run of Show</p>
            <h1 class="event-section__title"><%= @calendar.name %></h1>
            <p class="event-section__subtitle">Edit calendar details and keep the master schedule up to date.</p>
          </div>
          <%= form_with model: @calendar, url: event_calendar_path(@event), class: "event-form event-calendars__form", method: :patch do |form| %>
            <div class="event-calendars__form-grid">
              <div class="event-form__group">
                <%= form.label :name, "Calendar Name" %>
                <%= form.text_field :name, required: true %>
              </div>
              <div class="event-form__group">
                <%= form.label :timezone, "Timezone" %>
                <%= form.select :timezone, @time_zones.map { |tz| [tz.to_s, tz.tzinfo&.identifier || tz.name] }, {}, class: "event-form__select" %>
              </div>
              <div class="event-form__group event-calendars__description">
                <%= form.label :description, "Description" %>
                <%= form.text_area :description, rows: 3 %>
              </div>
              <div class="event-form__group event-form__group--checkbox event-calendars__visibility">
                <%= form.check_box :client_visible %>
                <%= form.label :client_visible, "Show on client portal" %>
              </div>
            </div>
            <div class="event-form__actions event-calendars__actions">
              <%= form.submit "Save Details", class: "event-form__submit" %>
            </div>
          <% end %>
        </header>
      </section>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Schedule</p>
            <h2 class="event-section__title">Scheduled Items</h2>
            <p class="event-section__subtitle">Relative items can anchor to the start or end of another entry.</p>
          </div>
          <div class="event-calendars__schedule-actions">
            <%= form_with url: event_calendar_path(@event), method: :get, local: true, class: "event-calendars__toggle-form" do %>
              <%= hidden_field_tag :group_by_date, "0" %>
              <label class="event-calendars__toggle">
                <%= check_box_tag :group_by_date, "1", @group_by_date, onchange: "this.form.submit()" %>
                <span>Group by date</span>
              </label>
            <% end %>
            <%= link_to "Add Item", new_event_calendar_item_path(@event), class: "event-section__cta" %>
          </div>
        </header>

        <% if @items.any? %>
          <%= render "events/calendars/schedule_table",
                     items: @items,
                     calendar: @calendar,
                     group_by_date: @group_by_date,
                     item_link_proc: ->(item) { [item.title, edit_event_calendar_item_path(@event, item)] } %>
        <% else %>
          <div class="event-section__empty">
            <p>No items yet — start by adding your ceremony or kickoff milestone.</p>
          </div>
        <% end %>
      </section>

      <section class="event-section event-calendars__tags">
        <header class="event-section__header event-calendars__tags-header">
          <div>
            <p class="event-section__eyebrow">Tags</p>
            <h2 class="event-section__title">Organize by Tag</h2>
            <p class="event-section__subtitle">Color-coded tags help surface the right items in derived calendars.</p>
          </div>
        </header>

        <% if @tags.any? %>
          <ul class="event-calendars__tag-list">
            <% @tags.each do |tag| %>
              <li class="event-calendars__tag-row">
                <div class="event-calendars__tag-info">
                  <strong class="event-calendars__tag-name"><%= tag.name %></strong>
                  <span class="event-tag-pill" style="<%= calendar_tag_style(tag) %>"><%= tag.name %></span>
                  <span class="event-calendars__tag-count"><%= tag.calendar_items.count %> items</span>
                </div>
                <%= form_with model: tag, url: event_calendar_tag_path(@event, tag), class: "event-calendars__tag-form", method: :patch do |form| %>
                  <div class="event-calendars__tag-fields">
                    <%= form.text_field :name, placeholder: "Name", class: "event-calendars__input" %>
                    <%= form.text_field :color_token, placeholder: "Color", class: "event-calendars__input event-calendars__input--color" %>
                    <div class="event-calendars__tag-actions">
                      <%= form.submit "Save", class: "event-form__submit event-form__submit--small" %>
                      <%= button_to "Remove", event_calendar_tag_path(@event, tag), method: :delete, data: { turbo_confirm: "Remove this tag?" }, class: "event-form__cancel" %>
                    </div>
                  </div>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="event-section__empty">
            <p>No tags yet. Add one below to start grouping schedule items.</p>
          </div>
        <% end %>

        <%= form_with model: @new_tag, url: event_calendar_tags_path(@event), class: "event-form event-calendars__new-tag" do |form| %>
          <div class="event-calendars__tag-fields">
            <%= form.text_field :name, placeholder: "New tag", class: "event-calendars__input", required: true %>
            <%= form.text_field :color_token, placeholder: "Color (optional)", class: "event-calendars__input event-calendars__input--color" %>
            <div class="event-form__actions event-calendars__tag-actions">
              <%= form.submit "Add Tag", class: "event-form__submit event-form__submit--small" %>
            </div>
          </div>
        <% end %>
      </section>
      
      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Derived Calendars</p>
            <h2 class="event-section__title">Filtered Views</h2>
            <p class="event-section__subtitle">Tailor the run of show for vendors, clients, or internal teams.</p>
          </div>
          <%= link_to "Create Derived Calendar", new_event_calendar_view_path(@event), class: "event-section__cta" %>
        </header>

        <% if @views.any? %>
          <table class="event-table event-calendars__table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Tags</th>
                <th>Client Portal</th>
                <th>Items</th>
              </tr>
            </thead>
            <tbody>
              <% @views.each do |view| %>
                <tr>
                  <td><%= link_to view.name, event_calendar_view_path(@event, view), class: "event-calendars__title-link" %></td>
                  <td>
                    <% if view.tag_filter.present? %>
                      <%= view.tag_filter.map { |tag_id| @tags_by_id[tag_id]&.name }.compact.join(', ') %>
                    <% else %>
                      <span class="event-table__status">All items</span>
                    <% end %>
                  </td>
                  <td><%= view.client_visible? ? "Visible" : "Hidden" %></td>
                  <td><%= Calendars::ViewFilter.new(calendar: @calendar, view: view).items.count %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="event-section__empty">
            <p>No derived calendars yet. Use tags to group items, then create a filtered view.</p>
          </div>
        <% end %>
      </section>
    </div>
  </div>
<% end %>
