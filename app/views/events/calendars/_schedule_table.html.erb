<% items ||= [] %>
<% calendar ||= nil %>
<% group_by_date = !!group_by_date %>
<% group_label_proc = local_assigns[:group_label_proc] %>
<% show_tags = true if local_assigns[:show_tags].nil? %>
<% render_actions = local_assigns[:render_actions] %>
<% actions_header = local_assigns[:actions_header] || "" %>
<% item_link_proc = local_assigns[:item_link_proc] || ->(item) { [item.title, edit_event_calendar_item_path(calendar.event, item)] } %>

<table class="event-table event-calendars__table">
  <thead>
    <tr>
      <th class="event-calendars__schedule-column">Schedule</th>
      <th class="event-calendars__title-column">Title</th>
      <th>Vendor</th>
      <th>Location</th>
      <th>Team</th>
      <% if show_tags %>
        <th>Tags</th>
      <% end %>
      <% if render_actions %>
        <th><%= actions_header %></th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% current_bucket = nil %>
    <% items.each do |item| %>
      <% bucket_key = calendar_item_date_bucket(item, calendar.timezone) %>
      <% bucket_label = group_label_proc ? group_label_proc.call(item) : bucket_key %>
      <% if group_by_date && bucket_key != current_bucket %>
        <% current_bucket = bucket_key %>
        <tr class="event-calendars__date-row">
          <td colspan="<%= 5 + (show_tags ? 1 : 0) + (render_actions ? 1 : 0) %>"><span class="event-calendars__date-label"><%= bucket_label %></span></td>
        </tr>
      <% end %>

      <% title_text, title_path = item_link_proc.call(item) %>
      <tr class="event-calendars__row <%= calendar_item_row_classes(item) %>">
        <td class="event-calendars__schedule-column"><%= calendar_item_time_only_label_with_marker(item, calendar.timezone) %></td>
        <td class="event-calendars__title-column">
          <%= link_to title_text, title_path, class: "event-calendars__title-link" %>
          <% if item.notes.present? %>
            <p class="event-calendars__note"><%= simple_format(item.notes) %></p>
          <% end %>
        </td>
        <td><%= item.vendor_name.presence || "—" %></td>
        <td><%= item.location_name.presence || "—" %></td>
        <td>
          <% team_names = item.team_members.order(:name).pluck(:name) %>
          <% extras = item.additional_team_members.to_s.strip %>
          <% combined_team = [team_names.join(', '), extras].reject(&:blank?).join('; ') %>
          <%= combined_team.presence || "—" %>
        </td>
        <% if show_tags %>
          <td>
            <% if item.event_calendar_tags.any? %>
              <div class="event-tag-list">
                <% item.event_calendar_tags.each do |tag| %>
                  <span class="event-tag-pill" style="<%= calendar_tag_style(tag) %>"><%= tag.name %></span>
                <% end %>
              </div>
            <% else %>
              <span class="event-table__status">None</span>
            <% end %>
          </td>
        <% end %>
        <% if render_actions %>
          <td class="event-settings__milestone-row-actions"><%= render_actions.call(item) %></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>
