<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <section class="event-section calendar-grid">
        <header class="event-section__header calendar-grid__header">
          <div>
            <p class="event-section__eyebrow">Calendar Grid</p>
            <h1 class="event-section__title"><%= @view ? @view.name : @calendar.name %></h1>
            <p class="event-section__subtitle">
              Edit schedule details in a dense table. Times use <strong><%= calendar_timezone_label %></strong>.
            </p>
          </div>
          <div class="calendar-grid__header-actions">
            <%= link_to "Back to Calendar", return_path, class: "event-section__cta event-section__cta--secondary" %>
          </div>
        </header>

        <div class="calendar-grid__bulk">
          <h2 class="calendar-grid__bulk-title">Bulk actions</h2>
          <%= form_with url: grid_bulk_path, method: :patch, local: true, html: { id: "calendar-grid-bulk-form", class: "calendar-grid__bulk-form" } do |form| %>
            <div class="calendar-grid__bulk-row">
              <%= form.label :bulk_action, "Action", class: "calendar-grid__bulk-label" %>
              <%= form.select :bulk_action,
                              options_for_select([
                                ["Set status", "set_status"],
                                ["Update lock state", "set_locked"],
                                ["Add tags", "add_tags"],
                                ["Remove tags", "remove_tags"]
                              ]),
                              {},
                              class: "calendar-grid__bulk-select" %>
            </div>

            <div class="calendar-grid__bulk-row" data-calendar-grid-bulk-target="status">
              <%= form.label :status, "Status", class: "calendar-grid__bulk-label" %>
              <%= form.select :status,
                              options_for_select(@statuses.map { |status| [status.humanize, status] }),
                              {},
                              class: "calendar-grid__bulk-select" %>
            </div>

            <div class="calendar-grid__bulk-row" data-calendar-grid-bulk-target="locked">
              <%= form.label :locked, "Lock state", class: "calendar-grid__bulk-label" %>
              <%= form.select :locked,
                              options_for_select([["Lock selected", true], ["Unlock selected", false]]),
                              {},
                              class: "calendar-grid__bulk-select" %>
            </div>

            <div class="calendar-grid__bulk-row" data-calendar-grid-bulk-target="tags">
              <%= form.label :tag_ids, "Tags", class: "calendar-grid__bulk-label" %>
              <%= hidden_field_tag "bulk[tag_ids][]", "", form: "calendar-grid-bulk-form", id: nil %>
              <%= select_tag "bulk[tag_ids][]",
                             options_from_collection_for_select(@tags, :id, :name),
                             multiple: true,
                             size: 4,
                             class: "calendar-grid__bulk-select calendar-grid__bulk-select--tags" %>
            </div>

            <div class="calendar-grid__bulk-actions">
              <%= form.submit "Apply", class: "event-section__cta" %>
            </div>

            <p class="calendar-grid__bulk-hint">Select rows with the checkboxes before applying a bulk action.</p>
          <% end %>
        </div>

        <% if @items.any? %>
          <div class="calendar-grid__table-wrapper">
            <table class="calendar-grid__table">
              <thead>
                <tr>
                  <th scope="col" class="calendar-grid__column--select">Select</th>
                  <th scope="col">Title</th>
                  <th scope="col">Start</th>
                  <th scope="col">Duration (min)</th>
                  <th scope="col">Status</th>
                  <th scope="col">Locked</th>
                  <th scope="col">Tags</th>
                  <th scope="col">Location</th>
                  <th scope="col">Vendor</th>
                  <th scope="col">Notes</th>
                  <th scope="col">Additional Team</th>
                  <th scope="col" class="calendar-grid__column--actions"></th>
                </tr>
              </thead>
              <tbody>
                <% @items.each do |item| %>
                  <% form_id = dom_id(item, :grid_form) %>
                  <%= form_with model: item,
                                url: grid_item_path(item),
                                method: :patch,
                                local: true,
                                html: { id: form_id } do |form| %>
                  <% end %>
                  <tr class="calendar-grid__row <%= 'calendar-grid__row--locked' if item.locked? %>">
                    <td class="calendar-grid__cell calendar-grid__cell--select">
                      <%= check_box_tag "item_ids[]", item.id, false, form: "calendar-grid-bulk-form", class: "calendar-grid__select" %>
                    </td>
                    <td class="calendar-grid__cell">
                      <%= text_field_tag "calendar_item[title]", item.title, form: form_id, class: "calendar-grid__input" %>
                    </td>
                    <td class="calendar-grid__cell">
                      <% start_value = item.starts_at&.in_time_zone(@timezone)&.strftime("%Y-%m-%dT%H:%M") %>
                      <% if item.absolute? %>
                        <%= text_field_tag "calendar_item[starts_at]", start_value, form: form_id, class: "calendar-grid__input", type: "datetime-local" %>
                      <% else %>
                        <%= text_field_tag "calendar_item[starts_at]", start_value, form: form_id, class: "calendar-grid__input", type: "datetime-local", disabled: true %>
                        <p class="calendar-grid__hint">Relative to <%= item.relative_anchor&.title || "â€”" %> (<%= item.relative_before? ? "before" : "after" %> <%= item.relative_offset_minutes %> min)</p>
                      <% end %>
                    </td>
                    <td class="calendar-grid__cell">
                      <%= number_field_tag "calendar_item[duration_minutes]",
                                           item.duration_minutes,
                                           form: form_id,
                                           class: "calendar-grid__input calendar-grid__input--short",
                                           min: 0 %>
                    </td>
                    <td class="calendar-grid__cell">
                      <%= select_tag "calendar_item[status]",
                                     options_for_select(@statuses.map { |status| [status.humanize, status] }, item.status),
                                     form: form_id,
                                     class: "calendar-grid__select" %>
                    </td>
                    <td class="calendar-grid__cell calendar-grid__cell--toggle">
                      <%= hidden_field_tag "calendar_item[locked]", "0", form: form_id, id: nil %>
                      <label class="calendar-grid__checkbox">
                        <%= check_box_tag "calendar_item[locked]", "1", item.locked?, form: form_id %>
                        <span>Locked</span>
                      </label>
                    </td>
                    <td class="calendar-grid__cell">
                      <%= hidden_field_tag "calendar_item[event_calendar_tag_ids][]", "", form: form_id, id: nil %>
                      <%= select_tag "calendar_item[event_calendar_tag_ids][]",
                                     options_from_collection_for_select(@tags, :id, :name, item.event_calendar_tag_ids),
                                     form: form_id,
                                     multiple: true,
                                     size: 3,
                                     class: "calendar-grid__select calendar-grid__select--tags" %>
                    </td>
                    <td class="calendar-grid__cell">
                      <%= text_field_tag "calendar_item[location_name]", item.location_name, form: form_id, class: "calendar-grid__input" %>
                    </td>
                    <td class="calendar-grid__cell">
                      <%= text_field_tag "calendar_item[vendor_name]", item.vendor_name, form: form_id, class: "calendar-grid__input" %>
                    </td>
                    <td class="calendar-grid__cell">
                      <%= text_area_tag "calendar_item[notes]", item.notes, form: form_id, rows: 2, class: "calendar-grid__textarea" %>
                    </td>
                    <td class="calendar-grid__cell">
                      <%= text_field_tag "calendar_item[additional_team_members]", item.additional_team_members, form: form_id, class: "calendar-grid__input" %>
                    </td>
                    <td class="calendar-grid__cell calendar-grid__cell--actions">
                      <%= submit_tag "Save", form: form_id, class: "calendar-grid__save" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="event-section__empty">
            <p>No items available yet.</p>
          </div>
        <% end %>
      </section>
    </div>
  </div>
<% end %>

<% content_for :scripts do %>
  <script type="module">
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("calendar-grid-bulk-form");
      if (!form) return;

      const actionSelect = form.querySelector("select[name='bulk[bulk_action]']");
      const statusRow = form.querySelector('[data-calendar-grid-bulk-target="status"]');
      const lockedRow = form.querySelector('[data-calendar-grid-bulk-target="locked"]');
      const tagsRow = form.querySelector('[data-calendar-grid-bulk-target="tags"]');

      const updateVisibility = () => {
        const action = actionSelect.value;
        if (statusRow) statusRow.style.display = action === "set_status" ? "grid" : "none";
        if (lockedRow) lockedRow.style.display = action === "set_locked" ? "grid" : "none";
        if (tagsRow) tagsRow.style.display = action === "add_tags" || action === "remove_tags" ? "grid" : "none";
      };

      if (actionSelect) {
        actionSelect.addEventListener("change", updateVisibility);
        updateVisibility();
      }
    });
  </script>
<% end %>
