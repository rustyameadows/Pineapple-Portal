<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow"></p>
            <h1 class="event-section__title"><%= @view.name %></h1>
            <p class="event-section__subtitle">
              <%= @view.description.presence %>
            </p>
          </div>
          <div class="event-calendars__schedule-actions">
            <%= link_to "Edit as Sheet", grid_event_calendar_view_path(@event, @view), class: "event-section__cta event-section__cta--secondary" %>
            <%= link_to "Preview Timeline", timeline_preview_event_calendar_view_path(@event, @view), class: "event-section__cta event-section__cta--secondary" %>
            <%= link_to "Edit View", edit_event_calendar_view_path(@event, @view), class: "event-section__cta" %>
          </div>
        </header>

        <div class="event-section__body">
          <p class="event-section__note">
            Showing
            <% if @view.tag_filter.present? %>
              items tagged with
              <strong><%= @view.tag_filter.map { |tag_id| @tags_by_id[tag_id]&.name }.compact.join(', ') %></strong>.
            <% else %>
              all items from the run of show.
            <% end %>
            <% if @view.hide_locked? %>
              Locked items are hidden in this view.
            <% end %>
          </p>

          <% if @items.any? %>
            <% custom_group_label = if @view.slug == "decision-calendar"
                                      ->(item) {
                                        item.time_caption.presence || calendar_item_date_bucket(item, @calendar.timezone)
                                      }
                                    end %>
            <%= render "events/calendars/schedule_table",
                       items: @items,
                       calendar: @calendar,
                       group_by_date: true,
                       group_label_proc: custom_group_label,
                       show_tags: false,
                       item_link_proc: ->(item) { [item.title, edit_event_calendar_item_path(@event, item)] } %>
          <% else %>
            <div class="event-section__empty">
              <p>No items match this view yet.</p>
            </div>
          <% end %>

          <div class="event-section__actions">
            <%= link_to "Back to Run of Show", event_calendar_path(@event), class: "event-section__link" %>
          </div>
        </div>
      </section>
    </div>
  </div>
<% end %>
