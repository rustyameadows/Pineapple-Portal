<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Team</p>
            <h1 class="event-section__title">Client Access</h1>
            <p class="event-section__lead">Manage who from the client side can log into the portal and view event updates.</p>
          </div>
        </header>

        <div class="event-section__body">
          <div class="event-settings__team">
            <% if @client_team_members.any? %>
              <table class="event-table event-table--clients">
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Portal Access</th>
                    <th>Password Reset Link</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @client_team_members.each do |team_member| %>
                    <% user = team_member.user %>
                    <% reset_token = user.latest_active_password_reset_token %>
                    <% highlight_reset = flash[:highlight_reset_token_id].present? && reset_token&.id == flash[:highlight_reset_token_id].to_i %>
                    <% reset_url = reset_token.present? ? "#{request.base_url}#{client_password_reset_path(reset_token.token)}" : nil %>
                    <tr class="<%= highlight_reset ? "event-settings__reset-row" : nil %>">
                      <td><%= user.name %></td>
                      <td><%= user.email %></td>
                      <td><%= user.phone_number.presence || "â€”" %></td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <%= hidden_field_tag :return_to, request.fullpath %>
                          <label class="event-settings__toggle">
                            <%= hidden_field_tag "event_team_member[client_visible]", 0 %>
                            <%= check_box_tag "event_team_member[client_visible]", 1, team_member.client_visible?, onchange: "this.form.submit()", aria: { label: "Toggle portal access for #{user.name}" } %>
                            <span><%= team_member.client_visible? ? "Active" : "Disabled" %></span>
                          </label>
                        <% end %>
                      </td>
                      <td>
                        <% if reset_token.present? %>
                          <div class="event-settings__reset-card <%= "event-settings__reset-card--highlight" if highlight_reset %>"
                               data-reset-card
                               data-reset-expires-at="<%= reset_token.expires_at.iso8601 %>">
                            <div class="event-settings__reset-header">
                              <label for="reset-link-<%= reset_token.id %>" class="event-settings__reset-label">Reset link</label>
                              <button type="button" class="event-settings__reset-copy" data-reset-copy>Copy</button>
                            </div>
                            <input id="reset-link-<%= reset_token.id %>" type="text" class="event-settings__reset-input" value="<%= reset_url %>" readonly data-reset-input>
                            <div class="event-settings__reset-meta">
                              <span class="event-settings__reset-countdown" data-reset-countdown aria-live="polite"></span>
                              <span class="event-settings__reset-expiration">Expires <%= reset_token.expires_at.strftime('%b %-d, %Y %l:%M %p %Z') %></span>
                            </div>
                          </div>
                        <% else %>
                          <span class="event-settings__empty">No reset link yet.</span>
                        <% end %>
                      </td>
                      <td class="event-table__actions event-table__actions--stack">
                        <%= button_to "Generate Reset Link",
                                      issue_reset_event_team_member_path(@event, team_member),
                                      method: :post,
                                      params: { return_to: request.fullpath },
                                      class: "event-section__link",
                                      form: { class: "event-settings__inline-form" } %>
                        <%= link_to "Edit", edit_user_path(user, return_to: request.fullpath), class: "event-section__link" %>
                        <%= button_to "Remove",
                                      event_team_member_path(@event, team_member),
                                      method: :delete,
                                      params: { return_to: request.fullpath },
                                      data: { turbo_confirm: "Remove #{user.name}'s portal access?" },
                                      class: "event-section__link event-section__link--danger",
                                      form: { class: "event-settings__inline-form" } %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% else %>
              <p class="event-settings__empty">No client accounts are linked yet.</p>
            <% end %>

            <div class="event-settings__client-actions">
              <div class="event-settings__client-action">
                <h4>Add Client Account</h4>
                <%= form_with model: [@event, @client_team_member], url: event_team_members_path(@event), local: true, class: "event-settings__form event-settings__form--stack" do |form| %>
                  <%= hidden_field_tag :return_to, request.fullpath %>
                  <%= form.hidden_field :member_role, value: EventTeamMember::TEAM_ROLES[:client] %>
                  <%= form.hidden_field :client_visible, value: 1 %>

                  <%= form.fields_for :client_user_attributes do |client_fields| %>
                    <div class="event-settings__details-grid">
                      <div class="event-settings__field">
                        <%= client_fields.label :name, "Name" %>
                        <%= client_fields.text_field :name, required: true %>
                      </div>
                      <div class="event-settings__field">
                        <%= client_fields.label :email, "Email" %>
                        <%= client_fields.email_field :email, required: true, autocomplete: "email" %>
                      </div>
                      <div class="event-settings__field">
                        <%= client_fields.label :phone_number, "Phone" %>
                        <%= client_fields.telephone_field :phone_number, placeholder: "555-123-4567" %>
                      </div>
                    </div>
                  <% end %>

                  <p class="event-settings__hint">A temporary password will be generated and shown after saving so you can share it with the client.</p>

                  <div class="event-settings__form-actions">
                    <%= form.submit "Invite client" %>
                  </div>
                <% end %>
              </div>

              <% if @available_clients.any? %>
                <div class="event-settings__client-action">
                  <h4>Grant Existing Client Access</h4>
                  <%= form_with model: [@event, @client_link_member], url: event_team_members_path(@event), local: true, class: "event-settings__form event-settings__form--inline" do |form| %>
                    <%= hidden_field_tag :return_to, request.fullpath %>
                    <div class="event-settings__field">
                      <%= form.label :user_id, "Client" %>
                      <%= form.collection_select :user_id, @available_clients, :id, ->(user) { "#{user.name} (#{user.email})" }, include_blank: "Select client" %>
                    </div>
                    <%= form.hidden_field :member_role, value: EventTeamMember::TEAM_ROLES[:client] %>
                    <%= form.hidden_field :client_visible, value: 1 %>
                    <div class="event-settings__form-actions">
                      <%= form.submit "Grant access" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
<% end %>

<% content_for :scripts do %>
  <script type="module">
    const formatResetCountdown = (milliseconds) => {
      const totalSeconds = Math.max(0, Math.ceil(milliseconds / 1000));
      const totalMinutes = Math.ceil(totalSeconds / 60);
      const days = Math.floor(totalMinutes / (60 * 24));
      const hours = Math.floor((totalMinutes - (days * 24 * 60)) / 60);
      const minutes = totalMinutes - (days * 24 * 60) - (hours * 60);

      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${minutes}m`;
      if (minutes > 0) return `${minutes}m`;
      return "less than 1m";
    };

    const updateResetCountdown = (card) => {
      const countdownEl = card.querySelector("[data-reset-countdown]");
      const copyButton = card.querySelector("[data-reset-copy]");
      if (!countdownEl) return;

      const expiresAt = card.__resetExpiresAt || new Date(card.dataset.resetExpiresAt);
      if (Number.isNaN(expiresAt.getTime())) return;
      card.__resetExpiresAt = expiresAt;

      const remainingMs = expiresAt.getTime() - Date.now();
      if (remainingMs <= 0) {
        countdownEl.textContent = "Expired";
        card.classList.add("is-expired");
        if (copyButton) copyButton.disabled = true;
        return;
      }

      countdownEl.textContent = `Expires in ${formatResetCountdown(remainingMs)}`;
      card.classList.remove("is-expired");
      if (copyButton) copyButton.disabled = false;
    };

    const updateResetCountdowns = () => {
      document.querySelectorAll("[data-reset-card]").forEach((card) => updateResetCountdown(card));
    };

    const initResetCards = () => {
      document.querySelectorAll("[data-reset-card]").forEach((card) => {
        if (card.__resetCardInitialized) return;
        card.__resetCardInitialized = true;

        const copyButton = card.querySelector("[data-reset-copy]");
        const input = card.querySelector("[data-reset-input]");

        if (copyButton && input) {
          const defaultLabel = copyButton.textContent;
          copyButton.dataset.copyLabel = defaultLabel;

          copyButton.addEventListener("click", async () => {
            const text = input.value;

            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
              } else {
                input.select();
                input.setSelectionRange(0, text.length);
                document.execCommand("copy");
                input.blur();
              }
            } catch (error) {
              console.error("Failed to copy reset link", error);
              return;
            }

            copyButton.textContent = "Copied";
            copyButton.disabled = true;
            window.setTimeout(() => {
              if (!card.classList.contains("is-expired")) {
                copyButton.textContent = copyButton.dataset.copyLabel || defaultLabel;
                copyButton.disabled = false;
              }
            }, 1500);
          });
        }
      });

      updateResetCountdowns();
    };

    const installResetCardHandlers = () => {
      if (document.__resetCardHandlersInstalled) return;
      document.__resetCardHandlersInstalled = true;
      document.addEventListener("turbo:load", initResetCards);
      window.setInterval(updateResetCountdowns, 30000);
    };

    installResetCardHandlers();
    initResetCards();
  </script>
<% end %>
