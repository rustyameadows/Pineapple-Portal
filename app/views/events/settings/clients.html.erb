<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Team</p>
            <h1 class="event-section__title">Client Access</h1>
            <p class="event-section__lead">Manage who from the client side can log into the portal and view event updates.</p>
          </div>
        </header>

        <div class="event-section__body">
          <div class="event-settings__team">
            <% if @client_team_members.any? %>
              <table class="event-table event-table--clients">
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Portal Access</th>
                    <th>Password Reset Link</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @client_team_members.each do |team_member| %>
                    <% user = team_member.user %>
                    <% reset_token = user.latest_active_password_reset_token %>
                    <% highlight_reset = flash[:highlight_reset_token_id].present? && reset_token&.id == flash[:highlight_reset_token_id].to_i %>
                    <% reset_url = reset_token.present? ? "#{request.base_url}#{client_password_reset_path(reset_token.token)}" : nil %>
                    <tr class="<%= highlight_reset ? "event-settings__reset-row" : nil %>">
                      <td><%= user.name %></td>
                      <td><%= user.email %></td>
                      <td><%= user.phone_number.presence || "â€”" %></td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <label class="event-settings__toggle">
                            <%= hidden_field_tag "event_team_member[client_visible]", 0 %>
                            <%= check_box_tag "event_team_member[client_visible]", 1, team_member.client_visible?, onchange: "this.form.submit()", aria: { label: "Toggle portal access for #{user.name}" } %>
                            <span><%= team_member.client_visible? ? "Active" : "Disabled" %></span>
                          </label>
                        <% end %>
                      </td>
                      <td>
                        <% if reset_token.present? %>
                          <div class="event-settings__reset <%= "event-settings__reset--highlight" if highlight_reset %>">
                            <label for="reset-link-<%= reset_token.id %>" class="event-settings__reset-label">Share this link</label>
                            <input id="reset-link-<%= reset_token.id %>" type="text" class="event-settings__reset-input" value="<%= reset_url %>" readonly>
                            <p class="event-settings__reset-meta">Expires <%= reset_token.expires_at.strftime('%b %-d, %Y %l:%M %p %Z') %></p>
                          </div>
                        <% else %>
                          <span class="event-settings__empty">No reset link yet.</span>
                        <% end %>
                      </td>
                      <td class="event-table__actions event-table__actions--stack">
                        <%= button_to "Generate Reset Link", issue_reset_event_team_member_path(@event, team_member), method: :post, class: "event-section__link", form: { class: "event-settings__inline-form" } %>
                        <%= link_to "Edit", edit_user_path(user, return_to: clients_event_settings_path(@event)), class: "event-section__link" %>
                        <%= button_to "Remove", event_team_member_path(@event, team_member), method: :delete, data: { turbo_confirm: "Remove #{user.name}'s portal access?" }, class: "event-section__link event-section__link--danger", form: { class: "event-settings__inline-form" } %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% else %>
              <p class="event-settings__empty">No client accounts are linked yet.</p>
            <% end %>

            <div class="event-settings__client-actions">
              <div class="event-settings__client-action">
                <h4>Invite a Client</h4>
                <%= form_with model: [@event, @client_team_member], url: event_team_members_path(@event), local: true, class: "event-settings__form event-settings__form--stack" do |form| %>
                  <%= form.hidden_field :member_role, value: EventTeamMember::TEAM_ROLES[:client] %>
                  <%= form.hidden_field :client_visible, value: 1 %>

                  <%= form.fields_for :client_user_attributes do |client_fields| %>
                    <div class="event-settings__details-grid">
                      <div class="event-settings__field">
                        <%= client_fields.label :name, "Name" %>
                        <%= client_fields.text_field :name, required: true %>
                      </div>
                      <div class="event-settings__field">
                        <%= client_fields.label :email, "Email" %>
                        <%= client_fields.email_field :email, required: true, autocomplete: "email" %>
                      </div>
                      <div class="event-settings__field">
                        <%= client_fields.label :phone_number, "Phone" %>
                        <%= client_fields.telephone_field :phone_number, placeholder: "555-123-4567" %>
                      </div>
                    </div>
                  <% end %>

                  <p class="event-settings__hint">A temporary password will be generated and shown after saving so you can share it with the client.</p>

                  <div class="event-settings__form-actions">
                    <%= form.submit "Invite client" %>
                  </div>
                <% end %>
              </div>

              <% if @available_clients.any? %>
                <div class="event-settings__client-action">
                  <h4>Grant Existing Client Access</h4>
                  <%= form_with model: [@event, @client_link_member], url: event_team_members_path(@event), local: true, class: "event-settings__form event-settings__form--inline" do |form| %>
                    <div class="event-settings__field">
                      <%= form.label :user_id, "Client" %>
                      <%= form.collection_select :user_id, @available_clients, :id, ->(user) { "#{user.name} (#{user.email})" }, include_blank: "Select client" %>
                    </div>
                    <%= form.hidden_field :member_role, value: EventTeamMember::TEAM_ROLES[:client] %>
                    <%= form.hidden_field :client_visible, value: 1 %>
                    <div class="event-settings__form-actions">
                      <%= form.submit "Grant access" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
<% end %>
