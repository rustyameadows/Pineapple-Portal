<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Event Settings</p>
            <h1 class="event-section__title"><%= @event.name %></h1>
            <p class="event-section__lead">Update the essentials for this event and keep the client view in sync.</p>
          </div>
        </header>

        <div class="event-section__body">
          <%= render "events/settings/event_details_form", event: @event %>
        </div>
      </section>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Client Portal</p>
            <h2 class="event-section__title">Quick Links</h2>
            <p class="event-section__lead">Control the shortcuts clients see in the portal hero. Links display in the order listed below.</p>
          </div>
        </header>

        <div class="event-section__body">
          <div class="event-settings__quick-links">
            <% if @event_links.any? %>
              <ul class="event-settings__link-list">
                <% @event_links.each_with_index do |event_link, index| %>
                  <li class="event-settings__link-item">
                    <%= form_with model: [@event, event_link], local: true, html: { class: "event-settings__form" } do |form| %>
                      <div class="event-settings__field">
                        <%= form.label :label, "Label" %>
                        <%= form.text_field :label, required: true %>
                      </div>
                      <div class="event-settings__field">
                        <%= form.label :url, "URL" %>
                        <%= form.url_field :url, required: true %>
                      </div>
                      <div class="event-settings__form-actions">
                        <%= form.submit "Save changes" %>
                      </div>
                    <% end %>

                    <div class="event-settings__controls">
                      <% if index.positive? %>
                        <%= link_to "Move up", move_up_event_event_link_path(@event, event_link), data: { turbo_method: :patch }, class: "event-settings__control" %>
                      <% end %>
                      <% if index < @event_links.length - 1 %>
                        <%= link_to "Move down", move_down_event_event_link_path(@event, event_link), data: { turbo_method: :patch }, class: "event-settings__control" %>
                      <% end %>
                      <%= link_to "Remove", event_event_link_path(@event, event_link), data: { turbo_method: :delete, turbo_confirm: "Remove this quick link?" }, class: "event-settings__control event-settings__control--danger" %>
                    </div>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <p class="event-settings__empty">No quick links yet. Use the form below to add the first client shortcut.</p>
            <% end %>

            <div class="event-settings__new-link">
              <h3>Add Quick Link</h3>
              <%= form_with model: [@event, @event_link], local: true, html: { class: "event-settings__form" } do |form| %>
                <div class="event-settings__field">
                  <%= form.label :label, "Label" %>
                  <%= form.text_field :label, required: true %>
                </div>
                <div class="event-settings__field">
                  <%= form.label :url, "URL" %>
                  <%= form.url_field :url, required: true, placeholder: "https://" %>
                </div>
                <div class="event-settings__form-actions">
                  <%= form.submit "Add quick link" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Team</p>
            <h2 class="event-section__title">Planning Team</h2>
            <p class="event-section__lead">Control which planners are assigned to this event and visible to your clients.</p>
          </div>
        </header>

        <div class="event-section__body">
          <div class="event-settings__team">
            <h3>Planning Team</h3>
            <% if @planner_team_members.any? %>
              <table class="event-table">
                <thead>
                  <tr>
                    <th>Planner</th>
                    <th>Title</th>
                    <th>Phone</th>
                    <th>Visible to Clients</th>
                    <th>Lead Planner</th>
                    <th>Order</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @planner_team_members.each do |team_member| %>
                    <% user = team_member.user %>
                    <tr>
                      <td><%= link_to user.name, edit_user_path(user, return_to: event_settings_path(@event)), class: "event-section__link" %></td>
                      <td><%= user.title.presence || "—" %></td>
                      <td><%= user.phone_number.presence || "—" %></td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <label class="event-settings__toggle">
                            <%= hidden_field_tag "event_team_member[client_visible]", 0 %>
                            <%= check_box_tag "event_team_member[client_visible]", 1, team_member.client_visible?, onchange: "this.form.submit()", aria: { label: "Toggle client visibility for #{user.name}" } %>
                            <span>Visible</span>
                          </label>
                        <% end %>
                      </td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <label class="event-settings__toggle">
                            <%= hidden_field_tag "event_team_member[lead_planner]", 0 %>
                            <%= check_box_tag "event_team_member[lead_planner]", 1, team_member.lead_planner?, onchange: "this.form.submit()", aria: { label: "Toggle lead planner for #{user.name}" } %>
                            <span>Lead</span>
                          </label>
                        <% end %>
                      </td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <%= number_field_tag "event_team_member[position]", team_member.position, min: 0, class: "event-settings__position-input", onchange: "this.form.submit()", aria: { label: "Display order for #{user.name}" } %>
                        <% end %>
                      </td>
                      <td class="event-table__actions">
                        <%= button_to "Remove", event_team_member_path(@event, team_member), method: :delete, data: { turbo_confirm: "Remove #{user.name} from this event?" }, class: "event-section__link event-section__link--danger" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% else %>
              <p class="event-settings__empty">No planners are assigned yet. Add your planning team below.</p>
            <% end %>

            <div class="event-settings__new-link">
              <h3>Add Planner</h3>
              <% if @available_planners.any? %>
                <%= form_with model: [@event, @planner_team_member], url: event_team_members_path(@event), local: true, class: "event-settings__form" do |form| %>
                  <div class="event-settings__field">
                    <%= form.label :user_id, "Planner" %>
                    <%= form.collection_select :user_id, @available_planners, :id, ->(user) { "#{user.name}#{user.title.present? ? " – #{user.title}" : ""}" }, include_blank: "Select planner" %>
                  </div>
                  <%= form.hidden_field :member_role, value: EventTeamMember::TEAM_ROLES[:planner] %>
                  <div class="event-settings__form-actions">
                    <%= form.submit "Add to event" %>
                  </div>
                <% end %>
              <% else %>
                <p class="event-settings__empty">All planners are already assigned to this event.</p>
              <% end %>
            </div>

            <hr class="event-settings__divider">

            <h3>Client Access</h3>
            <% if @client_team_members.any? %>
              <table class="event-table event-table--clients">
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Portal Access</th>
                    <th>Password Reset Link</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @client_team_members.each do |team_member| %>
                    <% user = team_member.user %>
                    <% reset_token = user.latest_active_password_reset_token %>
                    <% highlight_reset = flash[:highlight_reset_token_id].present? && reset_token&.id == flash[:highlight_reset_token_id].to_i %>
                    <% reset_url = reset_token.present? ? "#{request.base_url}#{client_password_reset_path(reset_token.token)}" : nil %>
                    <tr class="<%= highlight_reset ? "event-settings__reset-row" : nil %>">
                      <td><%= user.name %></td>
                      <td><%= user.email %></td>
                      <td><%= user.phone_number.presence || "—" %></td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <label class="event-settings__toggle">
                            <%= hidden_field_tag "event_team_member[client_visible]", 0 %>
                            <%= check_box_tag "event_team_member[client_visible]", 1, team_member.client_visible?, onchange: "this.form.submit()", aria: { label: "Toggle portal access for #{user.name}" } %>
                            <span><%= team_member.client_visible? ? "Active" : "Disabled" %></span>
                          </label>
                        <% end %>
                      </td>
                      <td>
                        <% if reset_token.present? %>
                          <div class="event-settings__reset <%= "event-settings__reset--highlight" if highlight_reset %>">
                            <label for="reset-link-<%= reset_token.id %>" class="event-settings__reset-label">Share this link</label>
                            <input id="reset-link-<%= reset_token.id %>" type="text" class="event-settings__reset-input" value="<%= reset_url %>" readonly>
                            <p class="event-settings__reset-meta">Expires <%= reset_token.expires_at.strftime('%b %-d, %Y %l:%M %p %Z') %></p>
                          </div>
                        <% else %>
                          <span class="event-settings__empty">No reset link yet.</span>
                        <% end %>
                      </td>
                      <td class="event-table__actions event-table__actions--stack">
                        <%= button_to "Generate Reset Link", issue_reset_event_team_member_path(@event, team_member), method: :post, class: "event-section__link", form: { class: "event-settings__inline-form" } %>
                        <%= link_to "Edit", edit_user_path(user, return_to: event_settings_path(@event)), class: "event-section__link" %>
                        <%= button_to "Remove", event_team_member_path(@event, team_member), method: :delete, data: { turbo_confirm: "Remove #{user.name}'s portal access?" }, class: "event-section__link event-section__link--danger", form: { class: "event-settings__inline-form" } %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% else %>
              <p class="event-settings__empty">No client accounts are linked yet.</p>
            <% end %>

            <div class="event-settings__client-actions">
              <div class="event-settings__client-action">
                <h4>Invite a Client</h4>
                <%= form_with model: [@event, @client_team_member], url: event_team_members_path(@event), local: true, class: "event-settings__form event-settings__form--stack" do |form| %>
                  <%= form.hidden_field :member_role, value: EventTeamMember::TEAM_ROLES[:client] %>
                  <%= form.hidden_field :client_visible, value: 1 %>

                  <%= form.fields_for :client_user_attributes do |client_fields| %>
                    <div class="event-settings__details-grid">
                      <div class="event-settings__field">
                        <%= client_fields.label :name, "Name" %>
                        <%= client_fields.text_field :name, required: true %>
                      </div>
                      <div class="event-settings__field">
                        <%= client_fields.label :email, "Email" %>
                        <%= client_fields.email_field :email, required: true, autocomplete: "email" %>
                      </div>
                      <div class="event-settings__field">
                        <%= client_fields.label :phone_number, "Phone" %>
                        <%= client_fields.telephone_field :phone_number, placeholder: "555-123-4567" %>
                      </div>
                    </div>
                  <% end %>

                  <p class="event-settings__hint">A temporary password will be generated and shown after saving so you can share it with the client.</p>

                  <div class="event-settings__form-actions">
                    <%= form.submit "Invite client" %>
                  </div>
                <% end %>
              </div>

              <% if @available_clients.any? %>
                <div class="event-settings__client-action">
                  <h4>Grant Existing Client Access</h4>
                  <%= form_with model: [@event, @client_link_member], url: event_team_members_path(@event), local: true, class: "event-settings__form event-settings__form--inline" do |form| %>
                    <div class="event-settings__field">
                      <%= form.label :user_id, "Client" %>
                      <%= form.collection_select :user_id, @available_clients, :id, ->(user) { "#{user.name} (#{user.email})" }, include_blank: "Select client" %>
                    </div>
                    <%= form.hidden_field :member_role, value: EventTeamMember::TEAM_ROLES[:client] %>
                    <%= form.hidden_field :client_visible, value: 1 %>
                    <div class="event-settings__form-actions">
                      <%= form.submit "Grant access" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>

      <section class="event-section event-settings__milestones">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Milestones</p>
            <h2 class="event-section__title">Event Milestones</h2>
            <p class="event-section__lead">Key schedule moments tagged as milestones appear here for quick review.</p>
          </div>
        </header>

        <div class="event-section__body">
          <% if @milestone_items.any? %>
            <%= render "events/calendars/schedule_table",
                       items: @milestone_items,
                       calendar: @calendar,
                       group_by_date: false,
                       show_tags: false,
                       show_locked: false,
                       item_link_proc: ->(item) { [item.title, edit_event_calendar_item_path(@event, item)] } %>
          <% else %>
            <p class="event-settings__empty">No milestones yet. Use the actions below to designate important schedule moments.</p>
          <% end %>

          <div class="event-settings__milestone-actions">
            <%= link_to "Create Milestone", new_event_calendar_item_path(@event, milestone: 1), class: "event-section__cta" %>
            <%= link_to "Assign Existing Item", event_calendar_path(@event, group_by_date: 1), class: "event-section__link" %>
          </div>
        </div>
      </section>
    </div>
  </div>
<% end %>
