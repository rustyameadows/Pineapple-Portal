<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Event Settings</p>
            <h1 class="event-section__title"><%= @event.name %></h1>
            <p class="event-section__lead">Update the essentials for this event and keep the client view in sync.</p>
          </div>
        </header>

        <div class="event-section__body">
          <%= render "events/settings/event_details_form", event: @event %>
        </div>
      </section>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Client Portal</p>
            <h2 class="event-section__title">Quick Links</h2>
            <p class="event-section__lead">Control the shortcuts clients see in the portal hero. Links display in the order listed below.</p>
          </div>
        </header>

        <div class="event-section__body">
          <div class="event-settings__quick-links">
            <% if @event_links.any? %>
              <ul class="event-settings__link-list">
                <% @event_links.each_with_index do |event_link, index| %>
                  <li class="event-settings__link-item">
                    <%= form_with model: [@event, event_link], local: true, html: { class: "event-settings__form" } do |form| %>
                      <div class="event-settings__field">
                        <%= form.label :label, "Label" %>
                        <%= form.text_field :label, required: true %>
                      </div>
                      <div class="event-settings__field">
                        <%= form.label :url, "URL" %>
                        <%= form.url_field :url, required: true %>
                      </div>
                      <div class="event-settings__form-actions">
                        <%= form.submit "Save changes" %>
                      </div>
                    <% end %>

                    <div class="event-settings__controls">
                      <% if index.positive? %>
                        <%= link_to "Move up", move_up_event_event_link_path(@event, event_link), data: { turbo_method: :patch }, class: "event-settings__control" %>
                      <% end %>
                      <% if index < @event_links.length - 1 %>
                        <%= link_to "Move down", move_down_event_event_link_path(@event, event_link), data: { turbo_method: :patch }, class: "event-settings__control" %>
                      <% end %>
                      <%= link_to "Remove", event_event_link_path(@event, event_link), data: { turbo_method: :delete, turbo_confirm: "Remove this quick link?" }, class: "event-settings__control event-settings__control--danger" %>
                    </div>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <p class="event-settings__empty">No quick links yet. Use the form below to add the first client shortcut.</p>
            <% end %>

            <div class="event-settings__new-link">
              <h3>Add Quick Link</h3>
              <%= form_with model: [@event, @event_link], local: true, html: { class: "event-settings__form" } do |form| %>
                <div class="event-settings__field">
                  <%= form.label :label, "Label" %>
                  <%= form.text_field :label, required: true %>
                </div>
                <div class="event-settings__field">
                  <%= form.label :url, "URL" %>
                  <%= form.url_field :url, required: true, placeholder: "https://" %>
                </div>
                <div class="event-settings__form-actions">
                  <%= form.submit "Add quick link" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Team</p>
            <h2 class="event-section__title">Planning Team</h2>
            <p class="event-section__lead">Control which planners are assigned to this event and visible to your clients.</p>
          </div>
        </header>

        <div class="event-section__body">
          <div class="event-settings__team">
            <% if @team_members.any? %>
              <table class="event-table">
                <thead>
                  <tr>
                    <th>Planner</th>
                    <th>Title</th>
                    <th>Phone</th>
                    <th>Client Visible</th>
                    <th>Lead Planner</th>
                    <th>Order</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @team_members.each do |team_member| %>
                    <% user = team_member.user %>
                    <tr>
                      <td><%= user.name %></td>
                      <td><%= user.title.presence || "—" %></td>
                      <td><%= user.phone_number.presence || "—" %></td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <label class="event-settings__toggle">
                            <%= hidden_field_tag "event_team_member[client_visible]", 0 %>
                            <%= check_box_tag "event_team_member[client_visible]", 1, team_member.client_visible?, onchange: "this.form.submit()", aria: { label: "Toggle client visibility for #{user.name}" } %>
                            <span>Visible</span>
                          </label>
                        <% end %>
                      </td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <label class="event-settings__toggle">
                            <%= hidden_field_tag "event_team_member[lead_planner]", 0 %>
                            <%= check_box_tag "event_team_member[lead_planner]", 1, team_member.lead_planner?, onchange: "this.form.submit()", aria: { label: "Toggle lead planner for #{user.name}" } %>
                            <span>Lead</span>
                          </label>
                        <% end %>
                      </td>
                      <td>
                        <%= form_with url: event_team_member_path(@event, team_member), method: :patch, local: true, class: "event-settings__inline-form" do %>
                          <%= number_field_tag "event_team_member[position]", team_member.position, min: 0, class: "event-settings__position-input", onchange: "this.form.submit()", aria: { label: "Display order for #{user.name}" } %>
                        <% end %>
                      </td>
                      <td class="event-table__actions">
                        <%= button_to "Remove", event_team_member_path(@event, team_member), method: :delete, data: { turbo_confirm: "Remove #{user.name} from this event?" }, class: "event-section__link event-section__link--danger" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% else %>
              <p class="event-settings__empty">No planners are assigned yet. Add your planning team below.</p>
            <% end %>

            <div class="event-settings__new-link">
              <h3>Add Planner</h3>
              <% if @available_planners.any? %>
                <%= form_with model: [@event, @team_member], url: event_team_members_path(@event), local: true, class: "event-settings__form" do |form| %>
                  <div class="event-settings__field">
                    <%= form.label :user_id, "Planner" %>
                    <%= form.collection_select :user_id, @available_planners, :id, ->(user) { "#{user.name}#{user.title.present? ? " – #{user.title}" : ""}" }, include_blank: "Select planner" %>
                  </div>
                  <div class="event-settings__form-actions">
                    <%= form.submit "Add to event" %>
                  </div>
                <% end %>
              <% else %>
                <p class="event-settings__empty">All planners are already assigned to this event.</p>
              <% end %>
            </div>
          </div>
        </div>
      </section>

      <section class="event-section event-settings__milestones">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Milestones</p>
            <h2 class="event-section__title">Event Milestones</h2>
            <p class="event-section__lead">Key schedule moments tagged as milestones appear here for quick review.</p>
          </div>
        </header>

        <div class="event-section__body">
          <% if @milestone_items.any? %>
            <%= render "events/calendars/schedule_table",
                       items: @milestone_items,
                       calendar: @calendar,
                       group_by_date: false,
                       show_tags: false,
                       show_locked: false,
                       item_link_proc: ->(item) { [item.title, edit_event_calendar_item_path(@event, item)] } %>
          <% else %>
            <p class="event-settings__empty">No milestones yet. Use the actions below to designate important schedule moments.</p>
          <% end %>

          <div class="event-settings__milestone-actions">
            <%= link_to "Create Milestone", new_event_calendar_item_path(@event, milestone: 1), class: "event-section__cta" %>
            <%= link_to "Assign Existing Item", event_calendar_path(@event, group_by_date: 1), class: "event-section__link" %>
          </div>
        </div>
      </section>
    </div>
  </div>
<% end %>
