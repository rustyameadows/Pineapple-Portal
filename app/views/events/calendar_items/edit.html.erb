<% provide :page_shell do %>
  <div class="event-layout">
    <%= render "events/sidebar_navigation", event: @event %>

    <div class="event-layout__main">
      <%= render "shared/flash" %>

      <% if @dependent_items.present? %>
        <section class="event-section">
          <header class="event-section__header">
            <div>
              <p class="event-section__eyebrow">Relative Items</p>
              <h2 class="event-section__title">Anchored to this item</h2>
              <p class="event-section__subtitle">These items reference this entry as their anchor.</p>
            </div>
          </header>

          <%= render "events/calendars/schedule_table",
                     items: @dependent_items,
                     calendar: @calendar,
                     group_by_date: false,
                     show_tags: true,
                     show_relative: true,
                     item_link_proc: ->(item) { [item.title, edit_event_calendar_item_path(@event, item)] } %>
        </section>
      <% else %>
        <section class="event-section">
          <header class="event-section__header">
            <div>
              <p class="event-section__eyebrow">Relative Items</p>
              <h2 class="event-section__title">Anchored to this item</h2>
              <p class="event-section__subtitle">These items reference this entry as their anchor.</p>
            </div>
          </header>
          <div class="event-section__empty">
            <p>No items are anchored to this entry yet.</p>
          </div>
        </section>
      <% end %>

      <section class="event-section">
        <header class="event-section__header">
          <div>
            <p class="event-section__eyebrow">Run of Show</p>
            <h1 class="event-section__title">Edit Calendar Item</h1>
            <p class="event-section__subtitle"></p>
          </div>
        </header>

        <div class="event-section__body">
          <%= render "form", item: @item %>
        </div>
      </section>

	      <% if @dependent_items.present? %>
	        <div id="relative-impact-panel" class="relative-impact-overlay" style="display:none;">
	          <div class="event-section relative-impact-dialog" role="dialog" aria-modal="true" aria-label="Changes impact other items">
	            <header class="event-section__header">
	              <div>
	                <p class="event-section__eyebrow">Heads up</p>
	                <h2 class="event-section__title">Changes impact other items</h2>
	                <p class="event-section__subtitle">Changing this item will impact <%= @dependent_items.size %> other item<%= 's' if @dependent_items.size != 1 %>:</p>
	              </div>
	            </header>
	            <div class="event-section__body relative-impact-body">
	              <ul class="event-section__list">
	                <% @dependent_items.each do |item| %>
	                  <li class="event-section__list-item">
	                    <div>
                      <h3 class="event-section__list-title"><%= item.title %></h3>
                      <% if item.relative_anchor.present? %>
                        <p class="event-section__list-subtitle"><%= calendar_item_relative_label(item) %></p>
                      <% end %>
                    </div>
                    <div class="event-section__list-actions">
                      <%= link_to "Edit", edit_event_calendar_item_path(@event, item), class: "event-section__link" %>
	                    </div>
	                  </li>
	                <% end %>
	              </ul>
	              <div class="event-section__actions relative-impact-actions">
	                <button type="button" class="event-section__cta event-section__cta--secondary" data-impact-cancel>Cancel</button>
	                <button type="button" class="event-section__cta" data-impact-confirm>Confirm changes</button>
	              </div>
	            </div>
	          </div>
	        </div>

        <script>
          (function() {
            function ready(fn) {
              if (document.readyState !== "loading") {
                fn();
              } else {
                document.addEventListener("DOMContentLoaded", fn);
              }
              document.addEventListener("turbo:load", fn);
            }

            ready(function() {
              var form = document.querySelector(".calendar-item-form");
              var panel = document.getElementById("relative-impact-panel");
              var deleteLink = document.querySelector("[data-impact-delete]");
              if (!form || !panel) return;

              var confirmBtn = panel.querySelector("[data-impact-confirm]");
              var cancelBtn = panel.querySelector("[data-impact-cancel]");
              var lastSubmitter = null;
              var bypass = false;

              form.addEventListener("submit", function(event) {
                if (bypass) return;
                lastSubmitter = event.submitter || form.querySelector("[type='submit']");
                event.preventDefault();
                panel.style.display = "flex";
              });

              if (deleteLink) {
                deleteLink.addEventListener("click", function(event) {
                  if (bypass) return;
                  event.preventDefault();
                  lastSubmitter = deleteLink;
                  panel.style.display = "flex";
                });
              }

              if (cancelBtn) {
                cancelBtn.addEventListener("click", function() {
                  panel.style.display = "none";
                  bypass = false;
                });
              }

              if (confirmBtn) {
                confirmBtn.addEventListener("click", function() {
                  bypass = true;
                  panel.style.display = "none";
                  if (lastSubmitter && typeof lastSubmitter.click === "function") {
                    lastSubmitter.click();
                  } else {
                    form.submit();
                  }
                });
              }
            });
          })();
        </script>
      <% end %>
    </div>
  </div>
<% end %>
